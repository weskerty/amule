name: Build amuled armv7 AppImage

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 1 */3 *'
  push:
    paths:
      - 'README.md'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Clonar amule
        run: git clone --depth=1 https://github.com/amule-project/amule.git amule-src

      - name: Obtener hash commit
        id: hash
        run: |
          cd amule-src
          echo "short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Verificar si ya existe release
        id: check
        run: |
          TAG="${{ steps.hash.outputs.short }}"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG")
          echo "exists=$([ $STATUS = '200' ] && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: Instalar dependencias y toolchain ARMv7
        if: steps.check.outputs.exists == 'false'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential autoconf automake libtool pkg-config \
            gettext autopoint binutils-dev \
            gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf \
            binutils-arm-linux-gnueabihf \
            wget bzip2 \
            libcrypto++-dev \
            libboost-dev libboost-system-dev libboost-thread-dev \
            zlib1g-dev libpng-dev

      - name: Instalar libs ARMv7
        if: steps.check.outputs.exists == 'false'
        run: |
          sudo dpkg --add-architecture armhf
          sudo apt-get update
          sudo apt-get install -y \
            libcrypto++-dev:armhf \
            libboost-dev:armhf libboost-system-dev:armhf libboost-thread-dev:armhf \
            zlib1g-dev:armhf libpng-dev:armhf libpcre2-dev:armhf

      - name: Cache wxWidgets ARMv7
        if: steps.check.outputs.exists == 'false'
        id: cache-wx
        uses: actions/cache@v4
        with:
          path: /opt/wx-static-armv7
          key: wx-3.2.6-armv7-nodebug

      - name: Compilar wxWidgets ARMv7
        if: steps.check.outputs.exists == 'false' && steps.cache-wx.outputs.cache-hit != 'true'
        run: |
          wget -q https://github.com/wxWidgets/wxWidgets/releases/download/v3.2.6/wxWidgets-3.2.6.tar.bz2
          tar -xjf wxWidgets-3.2.6.tar.bz2
          cd wxWidgets-3.2.6
          CC=arm-linux-gnueabihf-gcc CXX=arm-linux-gnueabihf-g++ \
          ./configure \
            --prefix=/opt/wx-static-armv7 --host=arm-linux-gnueabihf \
            --disable-shared --disable-gui --disable-debug \
            --enable-unicode --with-zlib=sys --with-libpng=sys
          sed -i 's|cd utils/wxrc && make all||g' Makefile || true
          make -j"$(nproc)"
          sudo mkdir -p /opt/wx-static-armv7/lib /opt/wx-static-armv7/bin \
            /opt/wx-static-armv7/lib/wx/config \
            /opt/wx-static-armv7/lib/wx/include/arm-linux-gnueabihf-base-unicode-static-3.2/wx \
            /opt/wx-static-armv7/include
          sudo cp lib/libwx_baseu*.a /opt/wx-static-armv7/lib/
          sudo cp lib/wx/config/arm-linux-gnueabihf-base-unicode-static-3.2 \
                 /opt/wx-static-armv7/lib/wx/config/
          sudo ln -sf /opt/wx-static-armv7/lib/wx/config/arm-linux-gnueabihf-base-unicode-static-3.2 \
                      /opt/wx-static-armv7/bin/wx-config
          sudo cp lib/wx/include/arm-linux-gnueabihf-base-unicode-static-3.2/wx/setup.h \
                 /opt/wx-static-armv7/lib/wx/include/arm-linux-gnueabihf-base-unicode-static-3.2/wx/
          sudo cp -r include/wx /opt/wx-static-armv7/include/

      - name: autogen
        if: steps.check.outputs.exists == 'false'
        run: cd amule-src && ./autogen.sh

      - name: Fix wx include path
        if: steps.check.outputs.exists == 'false'
        run: sudo ln -sf /opt/wx-static-armv7/include /opt/wx-static-armv7/include/wx-3.2

      - name: Fix large files test
        if: steps.check.outputs.exists == 'false'
        run: sed -i 's/#include <wx\/wx.h>/#include <wx\/defs.h>/g' amule-src/configure

      - name: configure ARMv7
        if: steps.check.outputs.exists == 'false'
        working-directory: amule-src
        run: |
          CC=arm-linux-gnueabihf-gcc CXX=arm-linux-gnueabihf-g++ \
          ./configure \
            --host=arm-linux-gnueabihf --with-large-files \
            --disable-debug --enable-optimize --disable-monolithic \
            --enable-amule-daemon --disable-amulecmd --disable-webserver \
            --disable-cas --disable-alc --disable-alcc --disable-wxcas \
            --disable-ed2k --disable-fileview --disable-geoip --disable-upnp \
            --with-wx-config=/opt/wx-static-armv7/bin/wx-config \
            CXXFLAGS="-O2" LDFLAGS="-L/usr/lib/arm-linux-gnueabihf"

      - name: Symlinks libs wx
        if: steps.check.outputs.exists == 'false'
        run: |
          cd /opt/wx-static-armv7/lib
          for f in libwx_*-arm-linux-gnueabihf.a; do
            sudo ln -sf "$f" "${f/-arm-linux-gnueabihf/}"
          done
          find /home/runner/work -name "libwxexpat*.a" 2>/dev/null | xargs -I{} sudo cp {} . || true
          for f in libwxexpat*-arm-linux-gnueabihf.a; do
            [ -f "$f" ] && sudo ln -sf "$f" "${f/-arm-linux-gnueabihf/}" || true
          done

      - name: Build libs
        if: steps.check.outputs.exists == 'false'
        run: make -j"$(nproc)" -C amule-src/src/libs

      - name: Build amuled
        if: steps.check.outputs.exists == 'false'
        run: |
          make -j"$(nproc)" -C amule-src/src amuled
          arm-linux-gnueabihf-strip amule-src/src/amuled

      - name: Descargar linuxdeploy ARMv7
        if: steps.check.outputs.exists == 'false'
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-armhf.AppImage
          chmod +x linuxdeploy-armhf.AppImage

      - name: Crear AppDir
        if: steps.check.outputs.exists == 'false'
        run: |
          mkdir -p AppDir/usr/bin AppDir/usr/share/applications \
                   AppDir/usr/share/icons/hicolor/256x256/apps
          cp amule-src/src/amuled AppDir/usr/bin/amuled
          printf '[Desktop Entry]\nName=aMule Daemon\nExec=amuled\nIcon=amuled\nType=Application\nCategories=Network;\n' \
            > AppDir/usr/share/applications/amuled.desktop
          touch AppDir/usr/share/icons/hicolor/256x256/apps/amuled.png

      - name: Empaquetar AppImage
        if: steps.check.outputs.exists == 'false'
        env:
          ARCH: armhf
        run: |
          ./linuxdeploy-armhf.AppImage --appimage-extract > /dev/null
          ARCH=armhf ./squashfs-root/AppRun \
            --appdir AppDir \
            --executable AppDir/usr/bin/amuled \
            --desktop-file AppDir/usr/share/applications/amuled.desktop \
            --icon-file AppDir/usr/share/icons/hicolor/256x256/apps/amuled.png \
            --output appimage
          find . -maxdepth 1 -name "*.AppImage" ! -name "linuxdeploy*" -exec mv {} amuled-armv7.AppImage \;

      - name: Verificar AppImage
        if: steps.check.outputs.exists == 'false'
        run: file amuled-armv7.AppImage && ls -lh amuled-armv7.AppImage

      - uses: actions/upload-artifact@v4
        if: steps.check.outputs.exists == 'false'
        with:
          name: amuled-armv7-appimage
          path: amuled-armv7.AppImage

      - name: Publicar release
        if: steps.check.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.hash.outputs.short }}
          name: AutoUpdate
          body: |
            Read [readme](https://github.com/weskerty/aMuleD.bin?tab=readme-ov-file#install) to Install Easy.

<ins>Only .AppImage;</ins>
Automate Install \& AutoBoot ❌
Automated Update ❌
Automate Config ❌
          fail_on_unmatched_files: false
          files: amuled-armv7.AppImage
